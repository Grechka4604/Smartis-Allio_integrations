# Техническое задание: Интеграция с сервисом ALLIO

## 1. Цель  
Реализовать приём вебхуков от сервиса **ALLIO**, преобразование событий в фоновые задачи и синхронизацию данных о бронированиях (резервациях) в CRM через API ALLIO.

## 2. Общее описание  
Система должна:  
- Принимать вебхуки от ALLIO по публичному URL.  
- На основе полученного события создавать задачи на синхронизацию.  
- Выполнять синхронизацию данных о бронях через API ALLIO с учётом ограничений по квоте.  
- Сохранять полученные данные в схеме CRM.

Интеграция настраивается на уровне клиента и идентифицируется по уникальному `integration_uuid`.

## 3. Структура данных

### 3.1. Таблица `allio_webhook`  
Хранит входящие вебхуки от ALLIO.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | int | Первичный ключ |
| `integration_uuid` | string | UUID интеграции (из тела вебхука) |
| `command` | string | Тип события (например, `SPACE_CHANGED`) |
| `external_ids_array` | string | JSON-массив внешних ID броней, например: `"[111,222,333]"` |
| `created_at` | timestamp | Время получения вебхука |

> **Примечание:** `external_ids_array` хранится как строка в формате JSON. При обработке — парсится в массив.

### 3.2. Таблица `allio_tasks`  
Хранит задачи на синхронизацию данных.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | int | Первичный ключ |
| `external_ids` | string | JSON-массив внешних ID броней |
| `status` | int | Статус задачи (0 — новая, 1 — в обработке, 2 — завершена, 3 — ошибка) |
| `created_at` | timestamp | Время создания задачи |
| `entity` | string | Тип сущности (на текущем этапе — `"reserve"` или `"booking"`) |

## 4. Логика работы

### 4.1. Приём вебхука

Система:
- Находит настройки интеграции по URL вебхука.  
- Проверяет соответствие `uuid` из тела и `integration_uuid` в настройках.  
- При успешной валидации сохраняет запись в `allio_webhook` и возвращает HTTP 200.  
- В случае ошибки — возвращает HTTP 4xx, запись не создаётся.

### 4.2. Создание задач синхронизации

- Система обрабатывает новые записи из `allio_webhook`.  
- Для каждой записи создаёт одну или несколько задач в `allio_tasks`:  
  - `external_ids` = JSON-строка из поля `indexes`  
  - `status` = 0  
  - `entity` = `"reserve"` (на текущем этапе)  
- Исходные вебхуки помечаются как обработанные (логически или через архив).

### 4.3. Выполнение синхронизации

- Фоновый воркер выбирает задачи со статусом `0`.  
- Для каждой задачи:  
  - Отправляет запрос к API ALLIO для получения деталей по указанным `external_ids`.  
  - Сохраняет/обновляет данные в CRM.  
  - Устанавливает статус `2` (успешно) или `3` (ошибка).  
- **Важно:** при выполнении запросов к API ALLIO соблюдается квота — не более **2 запросов в секунду на один IP адрес**.  
  При необходимости — реализуется очередь с задержкой или токен-бакет для соблюдения лимита.


## 5. Ограничения по квоте

- ALLIO накладывает ограничение: **не более 2 исходящих запросов в секунду на один IP адрес**.  
- Система **обязана учитывать это ограничение** при выполнении синхронизации.  
- Рекомендуется реализовать механизм **ограничения частоты запросов (rate limiting)** на уровне интеграции (например, через shared-счётчик или очередь с таймером).

# Получение Броней из ALLIO
1. **Запрос активных интеграций**  
   Система запрашивает у базы данных список всех активных интеграций с ALLIO.
2. **Итерация по вчерашним задачам**  
   Для каждой активной интеграции выполняется цикл синхронизации по невыполненным задачам этой сущности
   command:
   - RESERVE_ADD
   - RESERVE_MOD
3. **Вызов API ALLIO**  
   Для текущей интеграции и даты отправляется POST-запрос к эндпоинту:   POST reserve/list

## Маппинг в CRM-схему для Броней
*Сущность Брони ALLIO*
| Поле в Smartis        | Поле в ALLIO           | Примечание / Пример значения                              |
|------------------------|------------------------|-----------------------------------------------------------|
| external_id            | id                     | 5421                                                      |
| CRM_custon_fields      | status                 | ACTIVE                                                    |
| СRM_custom_fileds      | type                   | PREPAID                                                   |
| created_at             | till                   | 2025-10-30 20:08:10                                       |
| СRM_custom_fileds      | space_id               | 2688                                                      |
| СRM_custom_fileds      | manager.id             | 10                                                        |
| СRM_custom_fileds      | manager.fullname       | Дик Елена Анатольевна                                     |
| СRM_custom_fileds      | manager.city           | Самара                                                    |
| СRM_custom_fileds      | manager.is_agency      | FALSE                                                     |
| СRM_custom_fileds      | comment                | Бронь продлена Астахов М. А. до 31.10.2025...             |
.....
 
_Примечания_:
- Из этой сущности формируем контакт и в ссылке на контакт (в Бронях) указываем его
- Ниже указан маппинг для контакта
- лучше все поля подтягивать


*Сущность Контакты ALLIO*
| Поле в Smartis        | Поле в ALLIO | Примечание / Пример значения |
|------------------------|--------------|-------------------------------|
| СRM_custom_fileds      | first        | Николай                       |
| СRM_custom_fileds      | middle       | Владимирович                  |
| СRM_custom_fileds      | last         | Омельченко                    |
| phone                  | phone        | #ERROR!                       |
| external_id            | id           |                               |


# Получение сделок из ALLIO

Система выполняет регулярную синхронизацию активных **контрактов (сделок)** из сервиса ALLIO по расписанию. Процесс организован как фоновая задача и включает следующие шаги:

### Общая логика

1. **Запрос активных интеграций**  
   Система запрашивает у базы данных список всех активных интеграций с ALLIO.
2. **Итерация по вчерашним задачам**  
   Для каждой активной интеграции выполняется цикл синхронизации по невыполненным задачам этой сущности
   command:
   - DEALCARD_ADD
   - DEALCARD_MOD 
3. **Вызов API ALLIO**  
   Для текущей интеграции и даты отправляется POST-запрос к эндпоинту:   POST dealcard/list

4. **Обработка ответа**  
При успешном ответе (`HTTP 200 OK`) система:
- Парсит полученные данные о контрактах (сделках).
- Преобразует их в формат CRM.
- Сохраняет или обновляет записи в базе данных.


## 6. Маппинг в CRM-схему для Сделок
*Сущность Карточки Сделки ALLIO*
| Поле в Smartis        | Поле в ALLIO           | Примечание / Пример значения                              |
|------------------------|------------------------|-----------------------------------------------------------|
| external_id            | id                     | 5421                                                      |
| CRM_custon_fields      | status                 | ACTIVE                                                    |
| СRM_custom_fileds      | type                   | PREPAID                                                   |
| created_at             | till                   | 2025-10-30 20:08:10                                       |
| СRM_custom_fileds      | space_id               | 2688                                                      |
| СRM_custom_fileds      | manager.id             | 10                                                        |
| СRM_custom_fileds      | manager.fullname       | Дик Елена Анатольевна                                     |
| СRM_custom_fileds      | manager.city           | Самара                                                    |
| СRM_custom_fileds      | manager.is_agency      | FALSE                                                     |
....

Примечания_:
- Из этой сущности формируем контакт и в ссылке на контакт (в Бронях) указываем его
- Ниже указан маппинг для контакта
- лучше все поля подтягивать

*Сущность Контакты ALLIO* (из объекта buyer)
| Поле в Smartis        | Поле в ALLIO | Примечание / Пример значения |
|------------------------|--------------|-------------------------------|
| СRM_custom_fileds      | first        | Николай                       |
| СRM_custom_fileds      | middle       | Владимирович                  |
| СRM_custom_fileds      | last         | Омельченко                    |
| phone                  | phone        | #ERROR!                       |
| external_id            | id           |                               |



# Контроль удаленных сущностей
- Если включен этот дизаблер в интеграции
- Тогда раз в сутки запускается синхрон удаления сущщностей
- Заходит в таблицу allio_tasks
- Берет все свежие задачи с comand = *_DEL
- Удаляет сущнсоти по external_id